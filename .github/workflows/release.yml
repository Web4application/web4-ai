name: Fancy Release Workflow

on:
  push:
    branches:
      - main

jobs:
  release:
    name: ðŸš€ Ship It!
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ðŸ·ï¸ Get Latest Tag
      id: latest_tag
      run: echo "latest_tag=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

    - name: ðŸ§  Determine New Version from PR Labels
      id: version_bump
      run: |
        labels=$(gh pr view --json labels -q ".labels[].name")
        if echo "$labels" | grep -q "major"; then bump="major"
        elif echo "$labels" | grep -q "minor"; then bump="minor"
        else bump="patch"
        fi

        version=$(echo "${{ env.latest_tag }}" | awk -F. -v b="$bump" '{
          if (b=="major") $1++;
          else if (b=="minor") $2++;
          else $3++;
          print "v"$1"."$2"."$3
        }')
        echo "next_version=$version" >> $GITHUB_ENV

    - name: âœï¸ Generate Changelog with Emojis
      run: |
        echo "## ðŸ“¦ Changes in ${{ env.next_version }}:" > changelog.md
        git log ${{ env.latest_tag }}..HEAD --pretty=format:"- ðŸ’¡ %s" >> changelog.md

    - name: ðŸ“¢ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.next_version }}
        name: Release ${{ env.next_version }}
        body_path: changelog.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ’¬ Comment on PR
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body "ðŸŽ‰ Released as [${{ env.next_version }}](https://github.com/${{ github.repository }}/releases/tag/${{ env.next_version }})"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ”” Slack Notification (Optional)
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{"text":"New release: ${{ env.next_version }} is live!"}' ${{ secrets.SLACK_WEBHOOK }}
